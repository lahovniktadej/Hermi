version: "3.3"

services:
    traefik:
        image: traefik:latest
        networks:
            - traefik-net-dev
        command:
            - --api.insecure=true
            - --providers.docker=true
            - --providers.docker.exposedbydefault=false
            - --entrypoints.http.address=:80
        ports:
            - 80:80
            - 8080:8080
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
    
    frontend:
        build:
            context: ./Frontend
            dockerfile: Dockerfile.dev
        networks:
            - traefik-net-dev
        labels:
            - traefik.enable=true
            - traefik.http.routers.frontend.entrypoints=http
            - traefik.http.routers.frontend.rule=PathPrefix(`/`)
        volumes:
            - ./Frontend/src:/app/src
            - ./Frontend/public:/app/public

    nalogi:
        build:
            context: ./Microservices/nalogi
            dockerfile: Dockerfile.dev
        networks:
            - traefik-net-dev
        environment:
            MYSQL_HOST: db
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            MYSQL_DATABASE: ${MYSQL_DATABASE}
        depends_on:
            - "db"
        labels:
            - traefik.enable=true
            - traefik.http.routers.nalogi.entrypoints=http
            - traefik.http.routers.nalogi.rule=PathPrefix(`/api`)
            - traefik.http.middlewares.api-stripprefix.stripprefix.prefixes=/api
            - traefik.http.routers.nalogi.middlewares=api-stripprefix
        volumes:
            - ./Microservices/nalogi:/app
            - maven:/root/.m2

    db:
        image: mysql
        networks:
            - traefik-net-dev
        environment:
            MYSQL_DATABASE: ${MYSQL_DATABASE}
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            MYSQL_ALLOW_EMPTY_PASSWORD: 1
        volumes:
            - nalogi-data:/var/lib/mysql

networks:
    traefik-net-dev:
        driver: bridge

volumes:
    maven:
    nalogi-data:
